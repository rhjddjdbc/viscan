pipeline {
    agent any

    environment {
        REPO_URL = 'https://github.com/rhjddjdbc/viscan.git'
        BUILD_DIR = 'build'
    }

    options {
        timestamps()
        ansiColor('xterm')
    }

    stages {

        stage('Checkout') {
            steps {
                echo "Cloning repository..."
                git branch: 'main', url: "${REPO_URL}"
            }
        }

        stage('Prepare') {
            steps {
                echo "Creating build directory..."
                sh 'mkdir -p ${BUILD_DIR}'
            }
        }

        stage('Build') {
            steps {
                echo "Compiling viscan..."
                sh '''
                    make clean || true
                    make
                '''
            }
        }

        stage('Test') {
            steps {
                echo "Running tests..."
                
                sh '''
                    if [ ! -f ./viscan ]; then
                        echo "viscan binary not found!"
                        exit 1
                    fi

                    echo "✔ Running smoke test..."
                    ./viscan --help > /dev/null

                    echo "✔ Running sample scan (expected to return 1 if infected)..."
                    ./viscan --verbose Makefile || true
                '''
            }
        }

        stage('Archive Artifacts') {
            steps {
                echo "Archiving build artifacts..."
                archiveArtifacts artifacts: 'viscan', fingerprint: true
            }
        }
    }

    post {
        success {
            echo 'Build completed successfully!'
        }
        failure {
            echo 'Build failed.'
        }
        always {
            echo 'Pipeline finished.'
        }
    }
}
