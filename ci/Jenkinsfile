pipeline {
    agent any

    environment {
        REPO_URL   = 'https://github.com/rhjddjdbc/viscan.git'
        BUILD_DIR  = 'build'
        BINARY     = 'viscan'
    }

    options {
        timestamps()
        ansiColor('xterm')
        skipDefaultCheckout()
    }

    stages {

        stage('Checkout') {
            steps {
                echo "Cloning repository..."
                git branch: 'main', url: "${REPO_URL}"
            }
        }

        stage('Prepare') {
            steps {
                echo "Creating build directory..."
                sh "mkdir -p ${BUILD_DIR}"
            }
        }

        stage('Build') {
            steps {
                echo "Compiling ${BINARY}..."
                sh '''
                    set -e
                    make clean || true
                    make
                '''
            }
        }

        stage('Test') {
            steps {
                echo "Running tests..."

                sh """
                    if [ ! -f ./${BINARY} ]; then
                        echo \"${BINARY} binary not found!\"
                        exit 1
                    fi

                    echo \"Running smoke test...\"
                    ./${BINARY} --help > /dev/null

                    echo \"Running sample scan...\"
                    # viscan returns 1 on infected -> allowed
                    ./${BINARY} --verbose Makefile || true
                """
            }
        }

        stage('Archive Artifacts') {
            steps {
                echo "Archiving build artifacts..."
                archiveArtifacts artifacts: "${BINARY}", fingerprint: true
            }
        }
    }

    post {
        success {
            echo 'Build completed successfully!'
        }
        failure {
            echo 'Build failed.'
        }
        always {
            echo 'Pipeline finished.'
        }
    }
}
